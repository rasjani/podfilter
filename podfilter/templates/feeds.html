{% extends "base.html" %}

{% block title %}Feeds & Filters - PodFilter{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
      <h1 class="mb-0">Manage Feeds & Filters</h1>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="showAddFeedModal()">Add Feed</button>
        <button class="btn btn-outline-light border" onclick="showImportModal()">Import OPML</button>
      </div>
    </div>
  </div>
</div>

{% set has_filters = filter_rules | length > 0 %}
{% if feeds or has_filters %}
<div class="row">
  <div class="col-lg-4 mb-4 mb-lg-0">
    <div class="list-group shadow-sm" id="feedList">
      <button type="button" class="list-group-item list-group-item-action d-flex flex-column align-items-start active" data-feed-id="all" onclick="selectFeed('all')">
        <span class="fw-semibold">All Feeds</span>
        <small class="text-muted">Filters applied globally</small>
      </button>
      {% for feed in feeds %}
      <button type="button" class="list-group-item list-group-item-action d-flex flex-column align-items-start" data-feed-id="{{ feed.id }}" onclick="selectFeed({{ feed.id }})">
        <span class="fw-semibold">{{ feed.title }}</span>
        <small class="text-muted text-truncate w-100">{{ feed.original_url }}</small>
      </button>
      {% endfor %}
    </div>
  </div>
  <div class="col-lg-8">
    <div id="feedDetails">
      <div class="feed-detail card shadow-sm mb-4" data-feed-id="all">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-3">
            <div>
              <h2 class="h4 mb-1">Global Filters</h2>
              <p class="text-muted mb-0">Rules here apply to every feed.</p>
            </div>
            <button class="btn btn-sm btn-outline-primary" onclick="openFilterModal(null, 'All Feeds')">Add Filter</button>
          </div>
          {% set global_rules = filter_rules | selectattr('feed_id', 'equalto', none) | list %}
          {% if global_rules %}
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Rule Type</th>
                  <th>Pattern</th>
                  <th>Action</th>
                  <th>Status</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for rule in global_rules %}
                <tr>
                  <td><span class="badge bg-info">{{ rule.rule_type.replace('_', ' ').title() }}</span></td>
                  <td class="text-break">{{ rule.pattern }}</td>
                  <td>
                    <span class="badge {% if rule.action == 'exclude' %}bg-danger{% else %}bg-success{% endif %}">
                      {{ rule.action.title() }}
                    </span>
                  </td>
                  <td>
                    <span class="badge {% if rule.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                      {% if rule.is_active %}Active{% else %}Inactive{% endif %}
                    </span>
                  </td>
                  <td class="text-end">
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteFilter({{ rule.id }})">Delete</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted mb-0">No global filters yet.</p>
          {% endif %}
          {% if not feeds %}
          <div class="alert alert-info mt-4 mb-0">
            Add your first feed to create feed-specific filters.
          </div>
          {% endif %}
        </div>
      </div>
      {% for feed in feeds %}
      <div class="feed-detail card shadow-sm mb-4 d-none" data-feed-id="{{ feed.id }}">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-3">
            <div>
              <h2 class="h4 mb-1">{{ feed.title }}</h2>
              <p class="text-muted mb-1">{{ feed.description or "No description available." }}</p>
              <a href="{{ feed.original_url }}" target="_blank" class="small">{{ feed.original_url }}</a>
            </div>
            <div class="d-flex gap-2">
              <a href="/export/rss/{{ feed.id }}" class="btn btn-sm btn-outline-primary">Export RSS</a>
              <button class="btn btn-sm btn-primary" onclick='openFilterModal({{ feed.id }}, {{ feed.title | tojson }})'>Add Filter</button>
            </div>
          </div>
          {% set feed_rules = filter_rules | selectattr('feed_id', 'equalto', feed.id) | list %}
          {% if feed_rules %}
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Rule Type</th>
                  <th>Pattern</th>
                  <th>Action</th>
                  <th>Status</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for rule in feed_rules %}
                <tr>
                  <td><span class="badge bg-info">{{ rule.rule_type.replace('_', ' ').title() }}</span></td>
                  <td class="text-break">{{ rule.pattern }}</td>
                  <td>
                    <span class="badge {% if rule.action == 'exclude' %}bg-danger{% else %}bg-success{% endif %}">
                      {{ rule.action.title() }}
                    </span>
                  </td>
                  <td>
                    <span class="badge {% if rule.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                      {% if rule.is_active %}Active{% else %}Inactive{% endif %}
                    </span>
                  </td>
                  <td class="text-end">
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteFilter({{ rule.id }})">Delete</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted mb-0">No filters defined for this feed yet.</p>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% else %}
<div class="row">
  <div class="col-12">
    <div class="text-center py-5">
      <h3 class="text-muted">No feeds added yet</h3>
      <p>Add your first RSS feed to get started!</p>
      <button class="btn btn-primary" onclick="showAddFeedModal()">Add Feed</button>
    </div>
  </div>
</div>
{% endif %}

<!-- Add Feed Modal -->
<div class="modal fade" id="addFeedModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add RSS Feed</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addFeedForm">
          <div class="mb-3">
            <label for="feedUrl" class="form-label">RSS Feed URL</label>
            <input type="url" class="form-control" id="feedUrl" name="url" placeholder="https://example.com/feed.xml" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="addFeed()">Add Feed</button>
      </div>
    </div>
  </div>
</div>

<!-- Import OPML Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Import OPML File</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="importForm" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="opmlFile" class="form-label">Select OPML File</label>
            <input type="file" class="form-control" id="opmlFile" name="opml_file" accept=".opml,.xml" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="importOpml()">Import</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Filter Modal -->
<div class="modal fade" id="addFilterModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Filter Rule</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addFilterForm">
          <input type="hidden" id="filterFeedId" name="feed_id">
          <div class="mb-3">
            <label class="form-label">Apply To</label>
            <div class="form-control-plaintext fw-semibold" id="filterScopeLabel">All Feeds</div>
          </div>
          <div class="mb-3">
            <label for="ruleType" class="form-label">Rule Type</label>
            <select class="form-select" id="ruleType" name="rule_type" required>
              <option value="title_contains">Title Contains</option>
              <option value="title_regex">Title Regex</option>
              <option value="description_contains">Description Contains</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="pattern" class="form-label">Pattern</label>
            <input type="text" class="form-control" id="pattern" name="pattern" placeholder="Enter text or regex pattern" required>
            <div class="form-text">
              For "contains" rules, use simple text. For regex rules, use valid regular expressions.
            </div>
          </div>
          <div class="mb-0">
            <label for="action" class="form-label">Action</label>
            <select class="form-select" id="action" name="action" required>
              <option value="exclude">Exclude (hide matching episodes)</option>
              <option value="include">Include (show only matching episodes)</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="addFilter()">Add Filter</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentFeedId = 'all';

function showAddFeedModal() {
  new bootstrap.Modal(document.getElementById('addFeedModal')).show();
}

function showImportModal() {
  new bootstrap.Modal(document.getElementById('importModal')).show();
}

function selectFeed(feedId) {
  const normalizedId = feedId === null ? 'all' : String(feedId);
  currentFeedId = normalizedId;

  document.querySelectorAll('#feedList .list-group-item').forEach((button) => {
    button.classList.toggle('active', button.getAttribute('data-feed-id') === normalizedId);
  });

  document.querySelectorAll('#feedDetails .feed-detail').forEach((detail) => {
    detail.classList.toggle('d-none', detail.getAttribute('data-feed-id') !== normalizedId);
  });
}

function openFilterModal(feedId, feedName) {
  const normalizedId = feedId === null ? '' : String(feedId);
  document.getElementById('filterFeedId').value = normalizedId;
  document.getElementById('filterScopeLabel').textContent = normalizedId ? feedName : 'All Feeds';

  new bootstrap.Modal(document.getElementById('addFilterModal')).show();
}

async function addFeed() {
  const form = document.getElementById('addFeedForm');
  const formData = new FormData(form);
  const data = Object.fromEntries(formData);

  try {
    const response = await fetch('/api/feeds', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + localStorage.getItem('access_token')
      },
      credentials: 'same-origin',
      body: JSON.stringify(data)
    });

    if (response.ok) {
      location.reload();
    } else {
      const error = await response.json();
      alert(error.detail || 'Failed to add feed');
    }
  } catch (error) {
    alert('Failed to add feed: ' + error.message);
  }
}

async function importOpml() {
  const form = document.getElementById('importForm');
  const formData = new FormData(form);

  try {
    const response = await fetch('/api/feeds/import-opml', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + localStorage.getItem('access_token')
      },
      credentials: 'same-origin',
      body: formData
    });

    if (response.ok) {
      const result = await response.json();
      alert(result.message);
      location.reload();
    } else {
      const error = await response.json();
      alert(error.detail || 'Import failed');
    }
  } catch (error) {
    alert('Import failed: ' + error.message);
  }
}

async function addFilter() {
  const form = document.getElementById('addFilterForm');
  const formData = new FormData(form);
  const data = Object.fromEntries(formData);

  if (!data.feed_id) {
    data.feed_id = null;
  } else {
    data.feed_id = parseInt(data.feed_id, 10);
  }

  try {
    const response = await fetch('/api/filter-rules', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + localStorage.getItem('access_token')
      },
      credentials: 'same-origin',
      body: JSON.stringify(data)
    });

    if (response.ok) {
      location.reload();
    } else {
      const error = await response.json();
      alert(error.detail || 'Failed to add filter rule');
    }
  } catch (error) {
    alert('Failed to add filter rule: ' + error.message);
  }
}

async function deleteFilter(ruleId) {
  if (!confirm('Are you sure you want to delete this filter rule?')) {
    return;
  }

  try {
    const response = await fetch(`/api/filter-rules/${ruleId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': 'Bearer ' + localStorage.getItem('access_token')
      },
      credentials: 'same-origin'
    });

    if (response.ok) {
      location.reload();
    } else {
      const error = await response.json();
      alert(error.detail || 'Failed to delete filter rule');
    }
  } catch (error) {
    alert('Failed to delete filter rule: ' + error.message);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  selectFeed(currentFeedId);
});
</script>
{% endblock %}
